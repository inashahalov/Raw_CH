
# –ü—Ä–æ–µ–∫—Ç "–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ü–∏–∫—á–∞"

## –û–≥–ª–∞–≤–ª–µ–Ω–∏–µ 

- [–û–ø–∏—Å–∞–Ω–∏–µ](#–æ–ø–∏—Å–∞–Ω–∏–µ)
- [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞](#–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞)
- [–£—á–∞—Å—Ç–Ω–∏–∫–∏ –∫–æ–º–∞–Ω–¥—ã](#—É—á–∞—Å—Ç–Ω–∏–∫–∏-–∫–æ–º–∞–Ω–¥—ã)
- [–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞](#—Å—Ç—Ä—É–∫—Ç—É—Ä–∞-–ø—Ä–æ–µ–∫—Ç–∞)
- [–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö](#–≥–µ–Ω–µ—Ä–∞—Ü–∏—è-–¥–∞–Ω–Ω—ã—Ö)
- [–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤ MongoDB](#–∑–∞–≥—Ä—É–∑–∫–∞-–¥–∞–Ω–Ω—ã—Ö-–≤-mongodb)
- [–ó–∞–ø—É—Å–∫ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã](#–∑–∞–ø—É—Å–∫-–∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã)
- [–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ MongoDB –≤ Kafka](#–∑–∞–≥—Ä—É–∑–∫–∞-–¥–∞–Ω–Ω—ã—Ö-–∏–∑-mongodb-–≤-kafka)
- [–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ Kafka –≤ ClickHouse (RAW)](#–∑–∞–≥—Ä—É–∑–∫–∞-–¥–∞–Ω–Ω—ã—Ö-–∏–∑-kafka-–≤-clickhouse-raw)
- [–û—á–∏—Å—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏ Materialized View (MART)](#–æ—á–∏—Å—Ç–∫–∞-–¥–∞–Ω–Ω—ã—Ö-–∏-materialized-view-mart)
- [–ù–∞—Å—Ç—Ä–æ–π–∫–∞ Grafana](#–Ω–∞—Å—Ç—Ä–æ–π–∫–∞-grafana)
- [Telegram-–±–æ—Ç –¥–ª—è –∞–ª–µ—Ä—Ç–∏–Ω–≥–∞](#telegram-–±–æ—Ç-–¥–ª—è-–∞–ª–µ—Ä—Ç–∏–Ω–≥–∞)
- [–ö–∞–∫ –∑–∞–ø—É—Å—Ç–∏—Ç—å](#–∫–∞–∫-–∑–∞–ø—É—Å—Ç–∏—Ç—å)


---

## –û–ø–∏—Å–∞–Ω–∏–µ

–î–∞–Ω–Ω—ã–π –ø—Ä–æ–µ–∫—Ç —Ä–µ–∞–ª–∏–∑—É–µ—Ç –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫—É—é —Å–∏—Å—Ç–µ–º—É –¥–ª—è —Å–µ—Ç–µ–≤–æ–≥–æ –º–∞–≥–∞–∑–∏–Ω–∞ "–ü–∏–∫—á–∞", –ø–æ–∑–≤–æ–ª—è—é—â—É—é —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ –ø—Ä–æ–¥–∞–≤–∞—Ç—å —Ç–æ–≤–∞—Ä—ã –∑–∞ —Å—á—ë—Ç:

- –°–±–æ—Ä–∞ –∏ —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∏–∑ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
- –û—á–∏—Å—Ç–∫–∏ –∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö
- –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–ª—é—á–µ–≤—ã—Ö –º–µ—Ç—Ä–∏–∫
- –ê–ª–µ—Ä—Ç–∏–Ω–≥–∞ –ø—Ä–∏ –∞–Ω–æ–º–∞–ª–∏—è—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–µ–≤—ã—à–µ–Ω–∏–µ 50% –¥—É–±–ª–∏–∫–∞—Ç–æ–≤)

---

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞


MongoDB (NoSQL) ‚Üí Kafka ‚Üí ClickHouse (RAW) ‚Üí Materialized View (MART) ‚Üí Grafana (Dashboard & Alerting)
```


## –£—á–∞—Å—Ç–Ω–∏–∫–∏ –∫–æ–º–∞–Ω–¥—ã

- –ò–ª—å—è –ù–∞—à–∞—Ö–∞–ª–æ–≤ (nashahalov@outlook.com)
---

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞
```
<img width="362" height="846" alt="image" src="https://github.com/user-attachments/assets/80d4aed8-ce23-4da3-b35b-82a373101e2e" />

```

---

## –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö

–°–∫—Ä–∏–ø—Ç `scripts/generate_data.py` –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç JSON-—Ñ–∞–π–ª—ã –¥–ª—è:

- 45 –º–∞–≥–∞–∑–∏–Ω–æ–≤
- 20 —Ç–æ–≤–∞—Ä–æ–≤
- 45 –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ–π
- 200 –ø–æ–∫—É–ø–æ–∫

<details>
<summary>–ü–æ–∫–∞–∑–∞—Ç—å –∫–æ–¥ (scripts/generate_data.py)</summary>

```python
# scripts/generate_data.py
import os
import json
import random
import uuid
from datetime import datetime, timedelta
from faker import Faker

fake = Faker("ru_RU")

os.makedirs("data/stores", exist_ok=True)
os.makedirs("data/products", exist_ok=True)
os.makedirs("data/customers", exist_ok=True)
os.makedirs("data/purchases", exist_ok=True)

categories = [
    "ü•ñ –ó–µ—Ä–Ω–æ–≤—ã–µ –∏ —Ö–ª–µ–±–æ–±—É–ª–æ—á–Ω—ã–µ –∏–∑–¥–µ–ª–∏—è",
    "ü•© –ú—è—Å–æ, —Ä—ã–±–∞, —è–π—Ü–∞ –∏ –±–æ–±–æ–≤—ã–µ",
    "ü•õ –ú–æ–ª–æ—á–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã",
    "üçè –§—Ä—É–∫—Ç—ã –∏ —è–≥–æ–¥—ã",
    "ü•¶ –û–≤–æ—â–∏ –∏ –∑–µ–ª–µ–Ω—å"
]

store_networks = [("–ë–æ–ª—å—à–∞—è –ü–∏–∫—á–∞", 30), ("–ú–∞–ª–µ–Ω—å–∫–∞—è –ü–∏–∫—á–∞", 15)]
stores = []

# === 1. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –º–∞–≥–∞–∑–∏–Ω–æ–≤ ===
for network, count in store_networks:
    for i in range(count):
        store_id = f"store-{len(stores)+1:03}"
        city = fake.city()
        store = {
            "store_id": store_id,
            "store_name": f"{network} ‚Äî –ú–∞–≥–∞–∑–∏–Ω –Ω–∞ {fake.street_name()}",
            "store_network": network,
            "store_type_description": f"{'–°—É–ø–µ—Ä–º–∞—Ä–∫–µ—Ç –±–æ–ª–µ–µ 200 –∫–≤.–º.' if network == '–ë–æ–ª—å—à–∞—è –ü–∏–∫—á–∞' else '–ú–∞–≥–∞–∑–∏–Ω —É –¥–æ–º–∞ –º–µ–Ω–µ–µ 100 –∫–≤.–º.'} –í—Ö–æ–¥–∏—Ç –≤ —Å–µ—Ç—å –∏–∑ {count} –º–∞–≥–∞–∑–∏–Ω–æ–≤.",
            "type": "offline",
            "categories": categories,
            "manager": {
                "name": fake.name(),
                "phone": fake.phone_number(),
                "email": fake.email()
            },
            "location": {
                "country": "–†–æ—Å—Å–∏—è",
                "city": city,
                "street": fake.street_name(),
                "house": str(fake.building_number()),
                "postal_code": fake.postcode(),
                "coordinates": {
                    "latitude": float(fake.latitude()),
                    "longitude": float(fake.longitude())
                }
            },
            "opening_hours": {
                "mon_fri": "09:00-21:00",
                "sat": "10:00-20:00",
                "sun": "10:00-18:00"
            },
            "accepts_online_orders": True,
            "delivery_available": True,
            "warehouse_connected": random.choice([True, False]),
            "last_inventory_date": datetime.now().strftime("%Y-%m-%d")
        }
        stores.append(store)
        with open(f"data/stores/{store_id}.json", "w", encoding="utf-8") as f:
            json.dump(store, f, ensure_ascii=False, indent=2)

# === 2. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–æ–≤–∞—Ä–æ–≤ ===
products = []
for i in range(20):
    product = {
        "id": f"prd-{1000+i}",
        "name": fake.word().capitalize() + " " + fake.word().capitalize(),
        "group": random.choice(categories),
        "description": fake.sentence(),
        "kbju": {
            "calories": round(random.uniform(50, 300), 1),
            "protein": round(random.uniform(0.5, 20), 1),
            "fat": round(random.uniform(0.1, 15), 1),
            "carbohydrates": round(random.uniform(0.5, 50), 1)
        },
        "price": round(random.uniform(30, 300), 2),
        "unit": random.choice(["—É–ø–∞–∫–æ–≤–∫–∞", "—à—Ç", "–∫–≥", "–ª"]),
        "origin_country": "–†–æ—Å—Å–∏—è",
        "expiry_days": random.randint(5, 30),
        "is_organic": random.choice([True, False]),
        "barcode": fake.ean(length=13),
        "manufacturer": {
            "name": fake.company(),
            "country": "–†–æ—Å—Å–∏—è",
            "website": f"https://{fake.domain_name()}",
            "inn": fake.bothify(text='##########')
        }
    }
    products.append(product)
    with open(f"data/products/{product['id']}.json", "w", encoding="utf-8") as f:
        json.dump(product, f, ensure_ascii=False, indent=2)

# === 3. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ–π ===
customers = []
for store in stores:
    customer_id = f"cus-{1000 + len(customers)}"
    customer = {
        "customer_id": customer_id,
        "first_name": fake.first_name(),
        "last_name": fake.last_name(),
        "email": fake.email(),
        "phone": fake.phone_number(),
        "birth_date": fake.date_of_birth(minimum_age=18, maximum_age=70).isoformat(),
        "gender": random.choice(["male", "female"]),
        "registration_date": datetime.now().isoformat(),
        "is_loyalty_member": True,
        "loyalty_card_number": f"LOYAL-{uuid.uuid4().hex[:10].upper()}",
        "purchase_location": store["location"],
        "delivery_address": {
            "country": "–†–æ—Å—Å–∏—è",
            "city": store["location"]["city"],
            "street": fake.street_name(),
            "house": str(fake.building_number()),
            "apartment": str(random.randint(1, 100)),
            "postal_code": fake.postcode()
        },
        "preferences": {
            "preferred_language": "ru",
            "preferred_payment_method": random.choice(["card", "cash"]),
            "receive_promotions": random.choice([True, False])
        }
    }
    customers.append(customer)
    with open(f"data/customers/{customer_id}.json", "w", encoding="utf-8") as f:
        json.dump(customer, f, ensure_ascii=False, indent=2)

# === 4. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ–∫—É–ø–æ–∫ ===
for i in range(200):
    customer = random.choice(customers)
    store = random.choice(stores)
    items = random.sample(products, k=random.randint(1, 3))
    purchase_items = []
    total = 0
    for item in items:
        qty = random.randint(1, 5)
        total_price = round(item["price"] * qty, 2)
        total += total_price
        purchase_items.append({
            "product_id": item["id"],
            "name": item["name"],
            "category": item["group"],
            "quantity": qty,
            "unit": item["unit"],
            "price_per_unit": item["price"],
            "total_price": total_price,
            "kbju": item["kbju"],
            "manufacturer": item["manufacturer"]
        })
    purchase = {
        "purchase_id": f"ord-{i+1:05}",
        "customer": {
            "customer_id": customer["customer_id"],
            "first_name": customer["first_name"],
            "last_name": customer["last_name"],
            "email": customer["email"], # –±—É–¥–µ—Ç –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–æ –ø–æ–∑–∂–µ
            "phone": customer["phone"], # –±—É–¥–µ—Ç –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–æ –ø–æ–∑–∂–µ
            "is_loyalty_member": customer["is_loyalty_member"],
            "loyalty_card_number": customer["loyalty_card_number"]
        },
        "store": {
            "store_id": store["store_id"],
            "store_name": store["store_name"],
            "store_network": store["store_network"],
            "location": store["location"]
        },
        "items": purchase_items,
        "total_amount": round(total, 2),
        "payment_method": random.choice(["card", "cash"]),
        "is_delivery": random.choice([True, False]),
        "delivery_address": customer["delivery_address"],
        "purchase_datetime": (datetime.now() - timedelta(days=random.randint(0, 90))).isoformat()
    }
    with open(f"data/purchases/{purchase['purchase_id']}.json", "w", encoding="utf-8") as f:
        json.dump(purchase, f, ensure_ascii=False, indent=2)

print("‚úÖ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –∑–∞–≤–µ—Ä—à–µ–Ω–∞: 45 –º–∞–≥–∞–∑–∏–Ω–æ–≤, 20 —Ç–æ–≤–∞—Ä–æ–≤, 45 –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ–π, 200 –ø–æ–∫—É–ø–æ–∫.")
```

</details>

---

## –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤ MongoDB

–°–∫—Ä–∏–ø—Ç `scripts/load_to_mongo.py` –∑–∞–≥—Ä—É–∂–∞–µ—Ç JSON-—Ñ–∞–π–ª—ã –≤ MongoDB.

<details>
<summary>–ü–æ–∫–∞–∑–∞—Ç—å –∫–æ–¥ (scripts/load_to_mongo.py)</summary>

```python
# scripts/load_to_mongo.py
import json
import os
from pymongo import MongoClient

client = MongoClient('mongodb://localhost:27018/')
db = client['piccha_db']

for folder in ["stores", "products", "customers", "purchases"]:
    collection = db[folder]
    collection.delete_many({})  # –û—á–∏—Å—Ç–∫–∞ –∫–æ–ª–ª–µ–∫—Ü–∏–∏
    for file in os.listdir(f"data/{folder}"):
        with open(f"data/{folder}/{file}", "r", encoding="utf-8") as f:
            data = json.load(f)
            collection.insert_one(data)
    print(f"‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ {collection.count_documents({})} –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –≤ –∫–æ–ª–ª–µ–∫—Ü–∏—é '{folder}'")
```

</details>

---

## –ó–∞–ø—É—Å–∫ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã

–§–∞–π–ª `docker-compose.yml` –∑–∞–ø—É—Å–∫–∞–µ—Ç:

- MongoDB
- Kafka + Zookeeper
- ClickHouse
- Grafana

<details>
<summary>–ü–æ–∫–∞–∑–∞—Ç—å –∫–æ–¥ (docker-compose.yml)</summary>

```yaml
version: '3.8'

services:
  zookeeper:
    image: confluentinc/cp-zookeeper:7.4.0
    container_name: piccha-zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    ports:
      - "2181:2181"
    networks:
      - piccha-net

  kafka:
    image: confluentinc/cp-kafka:7.4.0
    container_name: piccha-kafka
    depends_on:
      - zookeeper
    ports:
      - "9092:9092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://localhost:9092
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
    networks:
      - piccha-net

  mongodb:
    image: mongo:4.4
    container_name: piccha-mongo
    ports:
      - "27018:27017"
    volumes:
      - mongo_data:/data/db
    networks:
      - piccha-net

  clickhouse:
    image: clickhouse/clickhouse-server:23.12
    container_name: piccha-clickhouse
    ports:
      - "8123:8123"
      - "9000:9000"
    volumes:
      - clickhouse_data:/var/lib/clickhouse
      - ./config/clickhouse:/etc/clickhouse-server/config.d
    ulimits:
      nofile:
        soft: 262144
        hard: 262144
    networks:
      - piccha-net

  grafana:
    image: grafana/grafana:10.0.0
    container_name: piccha-grafana
    ports:
      - "3000:3000"
    environment:
      GF_SECURITY_ADMIN_PASSWORD: admin
      GF_USERS_ALLOW_SIGN_UP: "false"
    networks:
      - piccha-net

volumes:
  mongo_data:
  clickhouse_data:

networks:
  piccha-net:
    driver: bridge
```

</details>

---

## –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ MongoDB –≤ Kafka

–°–∫—Ä–∏–ø—Ç `scripts/kafka_producer.py` –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ MongoDB –≤ —Ç–æ–ø–∏–∫ `piccha_raw` Kafka, **—à–∏—Ñ—Ä—É—è** `email` –∏ `phone`.

<details>
<summary>–ü–æ–∫–∞–∑–∞—Ç—å –∫–æ–¥ (scripts/kafka_producer.py)</summary>

```python
# scripts/kafka_producer.py
from __future__ import annotations
import json
import time
from kafka import KafkaProducer
from pymongo import MongoClient
from cryptography.fernet import Fernet

# === –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–ª—é—á–∞ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è ===
ENCRYPTION_KEY = Fernet.generate_key()
cipher = Fernet(ENCRYPTION_KEY)
print(f"üîë –ö–ª—é—á —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è (—Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ!): {ENCRYPTION_KEY.decode()}")

# === –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ ===
def encrypt_field(value: str | None) -> str:
    if not value:
        return ""
    return cipher.encrypt(value.encode()).decode()

# === –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è ===
def normalize_phone(phone: str | None) -> str:
    if not phone:
        return ""
    digits = ''.join(filter(str.isdigit, phone))
    if len(digits) == 11 and digits.startswith('8'):
        digits = '7' + digits[1:]
    if len(digits) == 10:
        digits = '7' + digits
    if len(digits) == 11 and digits.startswith('7'):
        return f"+{digits}"
    return phone

def normalize_email(email: str | None) -> str:
    return email.strip().lower() if email else ""

# === –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Kafka –∏ MongoDB ===
producer = KafkaProducer(
    bootstrap_servers=['localhost:9092'],
    value_serializer=lambda x: json.dumps(x, ensure_ascii=False).encode('utf-8')
)

client = MongoClient('mongodb://localhost:27018/')
db = client['piccha_db']

collections = ['stores', 'products', 'customers', 'purchases']

for coll_name in collections:
    collection = db[coll_name]
    for doc in collection.find():
        doc.pop('_id', None)
        doc['_collection'] = coll_name

        # === –®–∏—Ñ—Ä—É–µ–º email –∏ phone ===
        if coll_name == 'customers':
            email = doc.get('email')
            phone = doc.get('phone')
            doc['email'] = encrypt_field(normalize_email(email))
            doc['phone'] = encrypt_field(normalize_phone(phone))

        if coll_name == 'stores':
            email = doc['manager'].get('email')
            phone = doc['manager'].get('phone')
            doc['manager']['email'] = encrypt_field(normalize_email(email))
            doc['manager']['phone'] = encrypt_field(normalize_phone(phone))

        producer.send('piccha_raw', value=doc)
        print(f"–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ Kafka: {coll_name} - {doc.get('store_id') or doc.get('id') or doc.get('customer_id') or doc.get('purchase_id')}")

        time.sleep(0.01)

producer.flush()
print("‚úÖ –í—Å–µ –¥–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –≤ Kafka —Ç–æ–ø–∏–∫ 'piccha_raw'")
```

</details>

---

## –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ Kafka –≤ ClickHouse (RAW)

–°–∫—Ä–∏–ø—Ç `scripts/kafka_to_clickhouse.py` —á–∏—Ç–∞–µ—Ç –∏–∑ Kafka, **–¥–µ—à–∏—Ñ—Ä—É–µ—Ç** `email` –∏ `phone`, –∏ –∑–∞–≥—Ä—É–∂–∞–µ—Ç –≤ **RAW** —Ç–∞–±–ª–∏—Ü—ã ClickHouse.

<details>
<summary>–ü–æ–∫–∞–∑–∞—Ç—å –∫–æ–¥ (scripts/kafka_to_clickhouse.py)</summary>

```python
# scripts/kafka_to_clickhouse.py

from __future__ import annotations
import json
import logging
from typing import Any, Dict, List
from datetime import datetime
from decimal import Decimal
from clickhouse_driver import Client
from cryptography.fernet import Fernet
from kafka import KafkaConsumer

# === –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è ===
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(levelname)s - %(message)s',
    handlers=[
        logging.StreamHandler()  # –í—ã–≤–æ–¥ –≤ –∫–æ–Ω—Å–æ–ª—å
        # logging.FileHandler('kafka_to_clickhouse.log') # –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –≤—ã–≤–æ–¥ –≤ —Ñ–∞–π–ª
    ]
)
logger = logging.getLogger(__name__)

# =============================================================================
# === –í–ê–ñ–ù–û: –í–°–¢–ê–í–¨–¢–ï –°–Æ–î–ê –ö–õ–Æ–ß –ò–ó –í–´–í–û–î–ê kafka_producer.py ====================
# === –ü–†–ò–ú–ï–†: b'DpY1VLwmMeRO18y5BTLIibyzd-BheI5N1NpxCoHdMBo=' =================
# === !!! –£–ë–ï–î–ò–¢–ï–°–¨, –ß–¢–û –ö–õ–Æ–ß –°–û–í–ü–ê–î–ê–ï–¢ –° –¢–ï–ú, –ß–¢–û –í kafka_producer.py !!! ====
# =============================================================================
ENCRYPTION_KEY = b'–í–°–¢–ê–í–¨–¢–ï_–°–Æ–î–ê_–°–í–û–ô_–ö–õ–Æ–ß_–ò–ó_kafka_producer.py'
cipher = Fernet(ENCRYPTION_KEY)

logger.info("üîë –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–ª—é—á —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è.")


# === –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –∏ –¥–µ—à–∏—Ñ—Ä–æ–≤–∫–∞ ===
def decrypt_phone_or_email(value: str | None) -> str:
    """
    –ü—ã—Ç–∞–µ—Ç—Å—è —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ. –ï—Å–ª–∏ –Ω–µ —É–¥–∞–µ—Ç—Å—è, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–∞–∫ –µ—Å—Ç—å.
    """
    if not value:
        return ""
    try:
        decrypted_value = cipher.decrypt(value.encode()).decode()
        logger.debug(f"–£—Å–ø–µ—à–Ω–æ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞–Ω–æ –∑–Ω–∞—á–µ–Ω–∏–µ.")
        return decrypted_value
    except Exception as e:
        logger.debug(f"–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ: {e}. –í–æ–∑–≤—Ä–∞—â–µ–Ω–æ –∫–∞–∫ –µ—Å—Ç—å.")
        return value  # fallback: –≤–µ—Ä–Ω—É—Ç—å –∫–∞–∫ –µ—Å—Ç—å


def normalize_phone(phone: str | None) -> str:
    """
    –ù–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç —Ç–µ–ª–µ—Ñ–æ–Ω–Ω—ã–π –Ω–æ–º–µ—Ä: –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ —Ñ–æ—Ä–º–∞—Ç—É +7XXXXXXXXXX.
    """
    if not phone:
        return ""
    # –ü—Ä–æ—Å—Ç–∞—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è: —É–±–∏—Ä–∞–µ–º –≤—Å–µ, –∫—Ä–æ–º–µ —Ü–∏—Ñ—Ä
    digits = ''.join(filter(str.isdigit, phone))
    if len(digits) == 11 and digits.startswith('8'):
        digits = '7' + digits[1:]
    if len(digits) == 10:
        digits = '7' + digits
    if len(digits) == 11 and digits.startswith('7'):
        return f"+{digits}"
    # –ï—Å–ª–∏ —Ñ–æ—Ä–º–∞—Ç –Ω–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª
    logger.debug(f"–¢–µ–ª–µ—Ñ–æ–Ω '{phone}' –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–º—É —Ñ–æ—Ä–º–∞—Ç—É.")
    return phone


def normalize_email(email: str | None) -> str:
    """
    –ù–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç email: –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ –Ω–∏–∂–Ω–µ–º—É —Ä–µ–≥–∏—Å—Ç—Ä—É –∏ —É–¥–∞–ª—è–µ—Ç –ø—Ä–æ–±–µ–ª—ã.
    """
    if not email:
        return ""
    return email.strip().lower()


# === –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞—Ç ===
def safe_parse_datetime(datetime_str: str | None) -> datetime:
    """
    –ë–µ–∑–æ–ø–∞—Å–Ω–æ –ø–∞—Ä—Å–∏—Ç —Å—Ç—Ä–æ–∫—É –¥–∞—Ç—ã-–≤—Ä–µ–º–µ–Ω–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ ISO. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç datetime –∏–ª–∏ epoch.
    """
    if not datetime_str:
        logger.warning("–ü–æ–ª—É—á–µ–Ω–∞ –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞ –¥–∞—Ç—ã-–≤—Ä–µ–º–µ–Ω–∏. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è 1970-01-01T00:00:00.")
        return datetime(1970, 1, 1)
    try:
        # fromisoformat –º–æ–∂–µ—Ç —Å–ø—Ä–∞–≤–∏—Ç—å—Å—è —Å 'Z' –≤ –∫–æ–Ω—Ü–µ, –∑–∞–º–µ–Ω–∏–º –Ω–∞ +00:00 –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏
        if datetime_str.endswith('Z'):
            parsed_dt = datetime.fromisoformat(datetime_str[:-1] + '+00:00')
        else:
            parsed_dt = datetime.fromisoformat(datetime_str)
        return parsed_dt
    except ValueError as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –¥–∞—Ç—ã-–≤—Ä–µ–º–µ–Ω–∏ '{datetime_str}': {e}. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è 1970-01-01T00:00:00.")
        return datetime(1970, 1, 1)


def safe_parse_date(
        date_str: str | None) -> datetime:  # –í–æ–∑–≤—Ä–∞—â–∞–µ–º datetime –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏, –∏—Å–ø–æ–ª—å–∑—É–µ–º .date() –ø—Ä–∏ –≤—Å—Ç–∞–≤–∫–µ
    """
    –ë–µ–∑–æ–ø–∞—Å–Ω–æ –ø–∞—Ä—Å–∏—Ç —Å—Ç—Ä–æ–∫—É –¥–∞—Ç—ã (YYYY-MM-DD). –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç datetime –∏–ª–∏ epoch.
    """
    if not date_str:
        logger.warning("–ü–æ–ª—É—á–µ–Ω–∞ –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞ –¥–∞—Ç—ã. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è 1970-01-01.")
        return datetime(1970, 1, 1)
    try:
        # –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ —Ñ–æ—Ä–º–∞—Ç YYYY-MM-DD
        parsed_dt = datetime.strptime(date_str, "%Y-%m-%d")
        return parsed_dt
    except ValueError as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –¥–∞—Ç—ã '{date_str}': {e}. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è 1970-01-01.")
        return datetime(1970, 1, 1)


# === –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ ClickHouse ===
# –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ—Ä—Ç 9000, –∫–∞–∫ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ –≤ docker-compose.yml
client = Client(host='localhost', port=9000)


# === –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü RAW ===
def create_raw_tables() -> None:
    """
    –°–æ–∑–¥–∞–µ—Ç –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö piccha_raw –∏ –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Ç–∞–±–ª–∏—Ü—ã, –µ—Å–ª–∏ –æ–Ω–∏ –µ—â–µ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç.
    –¢–∏–ø—ã ID –∏–∑–º–µ–Ω–µ–Ω—ã –Ω–∞ String.
    """
    client.execute("CREATE DATABASE IF NOT EXISTS piccha_raw")

    # –¢–∞–±–ª–∏—Ü–∞ –º–∞–≥–∞–∑–∏–Ω–æ–≤
    client.execute("""
    CREATE TABLE IF NOT EXISTS piccha_raw.stores (
        store_id String,
        store_name String,
        store_network String,
        store_type_description String,
        type String,
        categories Array(String),
        manager_name String,
        manager_phone String,
        manager_email String,
        location_country String,
        location_city String,
        location_street String,
        location_house String,
        location_postal_code String,
        location_latitude Float64,
        location_longitude Float64,
        opening_hours_mon_fri String,
        opening_hours_sat String,
        opening_hours_sun String,
        accepts_online_orders UInt8,
        delivery_available UInt8,
        warehouse_connected UInt8,
        last_inventory_date Date
    ) ENGINE = MergeTree() ORDER BY store_id
    """)

    # –¢–∞–±–ª–∏—Ü–∞ –ø—Ä–æ–¥—É–∫—Ç–æ–≤
    client.execute("""
    CREATE TABLE IF NOT EXISTS piccha_raw.products (
        id String,
        name String,
        group String,
        description String,
        kbju_calories Float32,
        kbju_protein Float32,
        kbju_fat Float32,
        kbju_carbohydrates Float32,
        price Float32,
        unit String,
        origin_country String,
        expiry_days UInt16,
        is_organic UInt8,
        barcode String,
        manufacturer_name String,
        manufacturer_country String,
        manufacturer_website String,
        manufacturer_inn String
    ) ENGINE = MergeTree() ORDER BY id
    """)

    # –¢–∞–±–ª–∏—Ü–∞ –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ–π
    client.execute("""
    CREATE TABLE IF NOT EXISTS piccha_raw.customers (
        customer_id String,
        first_name String,
        last_name String,
        email String,
        phone String,
        birth_date Date,
        gender String,
        registration_date DateTime,
        is_loyalty_member UInt8,
        loyalty_card_number String,
        purchase_location_store_id String,
        purchase_location_city String,
        delivery_address_city String,
        delivery_address_street String,
        delivery_address_house String,
        delivery_address_apartment String,
        delivery_address_postal_code String,
        preferred_language String,
        preferred_payment_method String,
        receive_promotions UInt8
    ) ENGINE = MergeTree() ORDER BY customer_id
    """)

    # –¢–∞–±–ª–∏—Ü–∞ –ø–æ–∫—É–ø–æ–∫ (–ø–ª–æ—Å–∫–∞—è, –ø–æ –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–µ –Ω–∞ —Ç–æ–≤–∞—Ä –≤ —á–µ–∫–µ)
    client.execute("""
    CREATE TABLE IF NOT EXISTS piccha_raw.purchases (
        purchase_id String,
        customer_id String,
        product_id String,
        quantity Int32,
        price Decimal(10, 2),
        purchase_date DateTime
    ) ENGINE = MergeTree() ORDER BY (purchase_id, product_id)
    """)

    # –¢–∞–±–ª–∏—Ü–∞ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –ø–æ–∫—É–ø–∫–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –µ—Å–ª–∏ –Ω—É–∂–Ω–∞ –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è)
    client.execute("""
    CREATE TABLE IF NOT EXISTS piccha_raw.purchase_items (
        purchase_id String,
        product_id String,
        item_name String,
        category String,
        quantity UInt32,
        unit String,
        price_per_unit Float32,
        total_price Float32,
        kbju_calories Float32,
        kbju_protein Float32,
        kbju_fat Float32,
        kbju_carbohydrates Float32,
        manufacturer_name String
    ) ENGINE = MergeTree() ORDER BY (purchase_id, product_id)
    """)


# === –û—Å–Ω–æ–≤–Ω–æ–π consumer ===
def main() -> None:
    """
    –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è: —Å–æ–∑–¥–∞–µ—Ç —Ç–∞–±–ª–∏—Ü—ã, –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ Kafka, —á–∏—Ç–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –∏ –≤—Å—Ç–∞–≤–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤ ClickHouse.
    """
    logger.info("üöÄ –ó–∞–ø—É—Å–∫ kafka_to_clickhouse consumer...")

    # –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—ã
    try:
        create_raw_tables()
        logger.info("‚úÖ –¢–∞–±–ª–∏—Ü—ã piccha_raw —Å–æ–∑–¥–∞–Ω—ã –∏–ª–∏ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç.")
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ç–∞–±–ª–∏—Ü: {e}")
        return  # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ, –µ—Å–ª–∏ —Ç–∞–±–ª–∏—Ü—ã –Ω–µ —Å–æ–∑–¥–∞–Ω—ã

    # –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ Kafka
    try:
        consumer = KafkaConsumer(
            'piccha_raw',
            bootstrap_servers=['localhost:9092'],
            auto_offset_reset='earliest',  # –ß–∏—Ç–∞–µ–º —Å –Ω–∞—á–∞–ª–∞, –µ—Å–ª–∏ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–µ—Ç
            enable_auto_commit=True,
            group_id='clickhouse-loader-v2',  # –ò–∑–º–µ–Ω–µ–Ω group_id –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –ø—Ä–æ–±–ª–µ–º —Å –ø—Ä–µ–¥—ã–¥—É—â–∏–º–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è–º–∏
            value_deserializer=lambda x: json.loads(x.decode('utf-8')),
            # session_timeout_ms=45000, # –£–≤–µ–ª–∏—á–µ–Ω–∏–µ —Ç–∞–π–º–∞—É—Ç–∞ —Å–µ—Å—Å–∏–∏, –µ—Å–ª–∏ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—å –º–µ–¥–ª–µ–Ω–Ω—ã–π
            # heartbeat_interval_ms=3000 # –ò–Ω—Ç–µ—Ä–≤–∞–ª heartbeat
        )
        logger.info("‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Kafka —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ.")
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Kafka: {e}")
        return

    logger.info("‚è≥ –û–∂–∏–¥–∞—é –¥–∞–Ω–Ω—ã–µ –∏–∑ Kafka —Ç–æ–ø–∏–∫–∞ 'piccha_raw'...")

    # –û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
    for message in consumer:
        try:
            # –ü–æ–ª—É—á–∞–µ–º JSON-–¥–æ–∫—É–º–µ–Ω—Ç –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è
            raw_doc: Dict[str, Any] = message.value
            collection_type: str = raw_doc.pop('_collection', 'unknown')

            logger.debug(f"üì• –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –∫–æ–ª–ª–µ–∫—Ü–∏–∏: {collection_type}")

            # –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –∫–æ–ª–ª–µ–∫—Ü–∏–∏
            if collection_type == 'stores':
                doc = raw_doc

                # –û–±—Ä–∞–±–æ—Ç–∫–∞ last_inventory_date
                last_inventory_date_dt = safe_parse_date(doc.get('last_inventory_date'))

                # –í—Å—Ç–∞–≤–∫–∞ –≤ —Ç–∞–±–ª–∏—Ü—É stores (piccha_raw)
                client.execute("""
                INSERT INTO piccha_raw.stores VALUES
                """, [(
                    doc['store_id'],
                    doc['store_name'],
                    doc['store_network'],
                    doc['store_type_description'],
                    doc['type'],
                    doc['categories'],
                    doc['manager']['name'],
                    normalize_phone(decrypt_phone_or_email(doc['manager'].get('phone'))),
                    doc['manager']['email'],  # –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ email –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –Ω–µ —à–∏—Ñ—Ä—É–µ—Ç—Å—è
                    doc['location']['country'],
                    doc['location']['city'],
                    doc['location']['street'],
                    doc['location']['house'],
                    doc['location']['postal_code'],
                    float(doc['location']['coordinates']['latitude']),
                    float(doc['location']['coordinates']['longitude']),
                    doc['opening_hours']['mon_fri'],
                    doc['opening_hours']['sat'],
                    doc['opening_hours']['sun'],
                    int(doc['accepts_online_orders']),
                    int(doc['delivery_available']),
                    int(doc['warehouse_connected']),
                    last_inventory_date_dt.date()  # –í—Å—Ç–∞–≤–∫–∞ Date
                )])
                logger.info(f"‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ –≤ ClickHouse: stores - {doc['store_id']}")

            elif collection_type == 'products':
                doc = raw_doc

                # –í—Å—Ç–∞–≤–∫–∞ –≤ —Ç–∞–±–ª–∏—Ü—É products (piccha_raw)
                client.execute("""
                INSERT INTO piccha_raw.products VALUES
                """, [(
                    doc['id'],
                    doc['name'],
                    doc['group'],
                    doc['description'],
                    float(doc['kbju']['calories']),
                    float(doc['kbju']['protein']),
                    float(doc['kbju']['fat']),
                    float(doc['kbju']['carbohydrates']),
                    float(doc['price']),
                    doc['unit'],
                    doc['origin_country'],
                    int(doc['expiry_days']),
                    int(doc['is_organic']),
                    doc['barcode'],
                    doc['manufacturer']['name'],
                    doc['manufacturer']['country'],
                    doc['manufacturer']['website'].strip(),
                    doc['manufacturer']['inn']
                )])
                logger.info(f"‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ –≤ ClickHouse: products - {doc['id']}")

            elif collection_type == 'customers':
                doc = raw_doc

                # –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞—Ç
                birth_date_dt = safe_parse_date(doc.get('birth_date'))
                registration_date_dt = safe_parse_datetime(doc.get('registration_date'))

                # –í—Å—Ç–∞–≤–∫–∞ –≤ —Ç–∞–±–ª–∏—Ü—É customers (piccha_raw)
                client.execute("""
                INSERT INTO piccha_raw.customers VALUES
                """, [(
                    doc['customer_id'],
                    doc['first_name'],
                    doc['last_name'],
                    normalize_email(decrypt_phone_or_email(doc.get('email'))),
                    normalize_phone(decrypt_phone_or_email(doc.get('phone'))),
                    birth_date_dt.date(),  # –í—Å—Ç–∞–≤–∫–∞ Date
                    doc['gender'],
                    registration_date_dt,  # –í—Å—Ç–∞–≤–∫–∞ DateTime
                    int(doc['is_loyalty_member']),
                    doc['loyalty_card_number'],
                    doc['purchase_location']['store_id'],
                    doc['purchase_location']['city'],
                    doc['delivery_address']['city'],
                    doc['delivery_address']['street'],
                    doc['delivery_address']['house'],
                    doc['delivery_address'].get('apartment', ''),  # –ú–æ–∂–µ—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞—Ç—å
                    doc['delivery_address']['postal_code'],
                    doc['preferences']['preferred_language'],
                    doc['preferences']['preferred_payment_method'],
                    int(doc['preferences']['receive_promotions'])
                )])
                logger.info(f"‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ –≤ ClickHouse: customers - {doc['customer_id']}")

            elif collection_type == 'purchases':
                doc = raw_doc

                # –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–±—â–µ–π –¥–∞—Ç—ã –ø–æ–∫—É–ø–∫–∏
                purchase_datetime_dt = safe_parse_datetime(doc.get('purchase_datetime'))

                # –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ —Ç–∞–±–ª–∏—Ü–∞ piccha_raw.purchases –æ–∂–∏–¥–∞–µ—Ç –ø–ª–æ—Å–∫–∏–µ –∑–∞–ø–∏—Å–∏
                # –ø–æ –æ–¥–Ω–æ–π –Ω–∞ –∫–∞–∂–¥—ã–π —Ç–æ–≤–∞—Ä (item) –≤ –∑–∞–∫–∞–∑–µ.
                items_list = doc.get('items', [])
                inserted_items_count = 0
                for item in items_list:
                    try:
                        # --- –í—Å—Ç–∞–≤–∫–∞ –≤ –æ—Å–Ω–æ–≤–Ω—É—é —Ç–∞–±–ª–∏—Ü—É –ø–æ–∫—É–ø–æ–∫ (–ø–æ –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–µ –Ω–∞ —Ç–æ–≤–∞—Ä) ---
                        client.execute("""
                        INSERT INTO piccha_raw.purchases VALUES
                        """, [(
                            doc['purchase_id'],
                            doc['customer']['customer_id'],
                            item['product_id'],  # product_id –∏–∑ item
                            int(item['quantity']),  # quantity –∏–∑ item
                            Decimal(str(item['price_per_unit'])),  # price_per_unit –∏–∑ item -> Decimal(10,2)
                            purchase_datetime_dt  # purchase_date –∏–∑ –æ–±—â–µ–π –¥–∞—Ç—ã –ø–æ–∫—É–ø–∫–∏
                        )])

                        # --- –í—Å—Ç–∞–≤–∫–∞ –≤ –¥–µ—Ç–∞–ª—å–Ω—É—é —Ç–∞–±–ª–∏—Ü—É —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –ø–æ–∫—É–ø–∫–∏ ---
                        client.execute("""
                        INSERT INTO piccha_raw.purchase_items VALUES
                        """, [(
                            doc['purchase_id'],
                            item['product_id'],
                            item['name'],
                            item['category'],
                            int(item['quantity']),
                            item['unit'],
                            float(item['price_per_unit']),
                            float(item['total_price']),
                            float(item['kbju']['calories']),
                            float(item['kbju']['protein']),
                            float(item['kbju']['fat']),
                            float(item['kbju']['carbohydrates']),
                            item['manufacturer']['name']
                        )])
                        inserted_items_count += 1

                    except KeyError as ke:
                        logger.error(
                            f"‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ –≤ item '{item.get('product_id', 'UNKNOWN')}': {ke}")
                        # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —ç—Ç–æ—Ç item, –Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É –¥—Ä—É–≥–∏—Ö
                        continue
                    except Exception as ie:
                        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ item '{item.get('product_id', 'UNKNOWN')}': {ie}")
                        continue

                logger.info(
                    f"‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ –≤ ClickHouse: purchases - {doc['purchase_id']} ({inserted_items_count} items)")

            else:
                logger.warning(f"‚ö†Ô∏è  –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–ª–ª–µ–∫—Ü–∏—è: {collection_type}")

        except Exception as e:
            logger.error(f"‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è: {e}", exc_info=True)
            # –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É —Å–ª–µ–¥—É—é—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π, –Ω–µ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º—Å—è –Ω–∞ –æ—à–∏–±–∫–µ
            continue

    logger.info("üèÅ Consumer –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.")


if __name__ == "__main__":
    main()
```

</details>

---

## –û—á–∏—Å—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏ Materialized View (MART)

–°–∫—Ä–∏–ø—Ç `scripts/clean_data.sql` —Å–æ–∑–¥–∞–µ—Ç **MART** —Ç–∞–±–ª–∏—Ü—ã –∏ **Materialized View**, –∫–æ—Ç–æ—Ä—ã–µ:

- –ü—Ä–æ–≤–µ—Ä—è—é—Ç –¥—É–±–ª–∏–∫–∞—Ç—ã
- –ü—Ä–æ–≤–µ—Ä—è—é—Ç NULL –∏ –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏
- –ü—Ä–æ–≤–µ—Ä—è—é—Ç –∞–¥–µ–∫–≤–∞—Ç–Ω–æ—Å—Ç—å –¥–∞—Ç
- –ü—Ä–∏–≤–æ–¥—è—Ç –¥–∞–Ω–Ω—ã–µ –∫ –Ω–∏–∂–Ω–µ–º—É —Ä–µ–≥–∏—Å—Ç—Ä—É

<details>
<summary>–ü–æ–∫–∞–∑–∞—Ç—å –∫–æ–¥ (scripts/clean_data.sql)</summary>

```sql
-- scripts/clean_data.sql

-- –°–æ–∑–¥–∞–Ω–∏–µ –±–∞–∑—ã MART
CREATE DATABASE IF NOT EXISTS piccha_mart;

-- –°–æ–∑–¥–∞–Ω–∏–µ MART-—Ç–∞–±–ª–∏—Ü
CREATE TABLE IF NOT EXISTS piccha_mart.purchases_mart (
    purchase_id String,
    customer_id String,
    store_id String,
    total_amount Float32,
    payment_method String,
    is_delivery UInt8,
    delivery_address_city String,
    delivery_address_street String,
    delivery_address_house String,
    delivery_address_apartment String,
    delivery_address_postal_code String,
    purchase_datetime DateTime
) ENGINE = MergeTree()
ORDER BY (purchase_datetime, purchase_id);

CREATE TABLE IF NOT EXISTS piccha_mart.customers_mart (
    customer_id String,
    first_name String,
    last_name String,
    email String,
    phone String,
    birth_date Date,
    gender String,
    registration_date DateTime,
    is_loyalty_member UInt8,
    loyalty_card_number String,
    purchase_location_store_id String,
    purchase_location_city String,
    delivery_address_city String,
    delivery_address_street String,
    delivery_address_house String,
    delivery_address_apartment String,
    delivery_address_postal_code String,
    preferred_language String,
    preferred_payment_method String,
    receive_promotions UInt8
) ENGINE = MergeTree()
ORDER BY customer_id;

-- Materialized View –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –∏ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–∫—É–ø–æ–∫
CREATE MATERIALIZED VIEW piccha_mart.purchases_mart_mv
TO piccha_mart.purchases_mart
AS SELECT
    purchase_id,
    customer_id,
    store_id,
    total_amount,
    lower(payment_method) AS payment_method,
    is_delivery,
    lower(delivery_address_city) AS delivery_address_city,
    lower(delivery_address_street) AS delivery_address_street,
    delivery_address_house,
    delivery_address_apartment,
    delivery_address_postal_code,
    purchase_datetime
FROM piccha_raw.purchases
WHERE
    purchase_id != '' AND purchase_id IS NOT NULL
    AND customer_id != '' AND customer_id IS NOT NULL
    AND store_id != '' AND store_id IS NOT NULL
    AND purchase_datetime <= now()
    AND total_amount > 0;

-- Materialized View –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –∏ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ–π
CREATE MATERIALIZED VIEW piccha_mart.customers_mart_mv
TO piccha_mart.customers_mart
AS SELECT
    customer_id,
    lower(first_name) AS first_name,
    lower(last_name) AS last_name,
    lower(email) AS email,
    phone,
    birth_date,
    lower(gender) AS gender,
    registration_date,
    is_loyalty_member,
    loyalty_card_number,
    purchase_location_store_id,
    lower(purchase_location_city) AS purchase_location_city,
    lower(delivery_address_city) AS delivery_address_city,
    lower(delivery_address_street) AS delivery_address_street,
    delivery_address_house,
    delivery_address_apartment,
    delivery_address_postal_code,
    lower(preferred_language) AS preferred_language,
    lower(preferred_payment_method) AS preferred_payment_method,
    receive_promotions
FROM piccha_raw.customers
WHERE
    customer_id != '' AND customer_id IS NOT NULL
    AND first_name != '' AND first_name IS NOT NULL
    AND last_name != '' AND last_name IS NOT NULL
    AND birth_date <= today()
    AND registration_date <= now();

-- –¢–∞–±–ª–∏—Ü–∞ –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
CREATE TABLE IF NOT EXISTS piccha_mart.duplicates_log (
    table_name String,
    duplicate_count UInt64,
    total_count UInt64,
    duplicate_percentage Float32,
    timestamp DateTime DEFAULT now()
) ENGINE = MergeTree()
ORDER BY (table_name, timestamp);

-- Materialized View –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ (–ø—Ä–∏–º–µ—Ä –¥–ª—è purchases)
-- –í —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏, –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ –ø–æ–¥—Å—á–µ—Ç–∞ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –º–æ–∂–µ—Ç –ø–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å—Å—è –±–æ–ª–µ–µ —Å–ª–æ–∂–Ω—ã–π –∑–∞–ø—Ä–æ—Å –∏–ª–∏ —Ç—Ä–∏–≥–≥–µ—Ä.
-- –≠—Ç–æ—Ç MV –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –æ–±—â–∏–π –ø—Ä–∏–Ω—Ü–∏–ø.
CREATE MATERIALIZED VIEW piccha_mart.duplicates_log_mv
TO piccha_mart.duplicates_log
AS
SELECT
    'purchases' AS table_name,
    (SELECT count(*) - uniq(purchase_id) FROM piccha_raw.purchases WHERE purchase_id != '' AND purchase_id IS NOT NULL) AS duplicate_count,
    (SELECT count(*) FROM piccha_raw.purchases WHERE purchase_id != '' AND purchase_id IS NOT NULL) AS total_count,
    (duplicate_count * 100.0) / total_count AS duplicate_percentage
FROM system.one
WHERE duplicate_percentage > 50;
```

</details>

---

## –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Grafana

### 7.1. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –¥–∞–Ω–Ω—ã—Ö ClickHouse

1. –û—Ç–∫—Ä–æ–π Grafana: `http://localhost:3000`
2. –ü–µ—Ä–µ–π–¥–∏ –≤ **Configuration ‚Üí Data Sources**
3. –ù–∞–∂–º–∏ **Add data source**
4. –í—ã–±–µ—Ä–∏ **ClickHouse**
5. –£–∫–∞–∂–∏:
   - **URL**: `http://clickhouse:8123` (–µ—Å–ª–∏ Grafana –≤ Docker) –∏–ª–∏ `http://localhost:8123` (–µ—Å–ª–∏ –Ω–∞ —Ö–æ—Å—Ç–µ)
   - **Database**: `piccha_raw`
   - **User**: `default`
   - **Password**: (–æ—Å—Ç–∞–≤—å –ø—É—Å—Ç—ã–º)

### 7.2. –°–æ–∑–¥–∞–Ω–∏–µ –¥–∞—à–±–æ—Ä–¥–∞

1. –ü–µ—Ä–µ–π–¥–∏ –≤ **Create ‚Üí Dashboard**
2. –î–æ–±–∞–≤—å –ø–∞–Ω–µ–ª—å:
   - **Query**:
     ```sql
     SELECT COUNT(*) AS "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–∫—É–ø–æ–∫" FROM piccha_raw.purchases
     ```
   - **Format as**: `SingleStat`
3. –î–æ–±–∞–≤—å –µ—â—ë –æ–¥–Ω—É –ø–∞–Ω–µ–ª—å:
   - **Query**:
     ```sql
     SELECT COUNT(DISTINCT store_id) AS "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–∞–≥–∞–∑–∏–Ω–æ–≤" FROM piccha_raw.stores
     ```
   - **Format as**: `SingleStat`

   <img width="629" height="519" alt="1 –∑–∞–¥–∞–Ω–∏–µ" src="https://github.com/user-attachments/assets/a5bbef9d-ecd2-4ab7-adeb-2cbb08d08a52" />


### 7.3. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–ª–µ—Ä—Ç–∏–Ω–≥–∞ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤

1. –ü–µ—Ä–µ–π–¥–∏ –≤ **Alerting ‚Üí Contact points**
2. –î–æ–±–∞–≤—å **Telegram**:
   - –í—Å—Ç–∞–≤—å **—Ç–æ–∫–µ–Ω –±–æ—Ç–∞** –∏ **ID —á–∞—Ç–∞**
3. –ü–µ—Ä–µ–π–¥–∏ –≤ **Alerting ‚Üí Alert rules**
4. –°–æ–∑–¥–∞–π –ø—Ä–∞–≤–∏–ª–æ:
   - **Query**:
     ```sql
     SELECT duplicate_percentage FROM piccha_mart.duplicates_log ORDER BY timestamp DESC LIMIT 1
     ```
   - **Condition**: `IS ABOVE 50`
   - **Contact point**: Telegram
5. –°–æ—Ö—Ä–∞–Ω–∏ –∞–ª–µ—Ä—Ç.
6. –°–¥–µ–ª–∞–π —Å–∫—Ä–∏–Ω—à–æ—Ç –∏ —Å–æ—Ö—Ä–∞–Ω–∏ –∫–∞–∫ `telegram_alert_screenshot.png` –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞.

---

## Telegram-–±–æ—Ç –¥–ª—è –∞–ª–µ—Ä—Ç–∏–Ω–≥–∞

- –ù–∞–∑–≤–∞–Ω–∏–µ: `PicchaAlertBot`
- –¢–æ–∫–µ–Ω: `123456789:ABCdefGHIjklMNOpqrSTUvwxYZ`
- –°–∫—Ä–∏–Ω—à–æ—Ç —Ä–∞–±–æ—Ç—ã: `telegram_alert_screenshot.png`

---

## –ö–∞–∫ –∑–∞–ø—É—Å—Ç–∏—Ç—å

1. `docker-compose up -d`
2. `python scripts/generate_data.py`
3. `python scripts/load_to_mongo.py`
4. `python scripts/kafka_producer.py` (—Å–∫–æ–ø–∏—Ä—É–π—Ç–µ –∫–ª—é—á —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è –∏–∑ –≤—ã–≤–æ–¥–∞)
5. –í—Å—Ç–∞–≤—å—Ç–µ –∫–ª—é—á –≤ `scripts/kafka_to_clickhouse.py`
6. `python scripts/kafka_to_clickhouse.py`
7. `clickhouse-client < scripts/clean_data.sql`
8. –ù–∞—Å—Ç—Ä–æ–π Grafana ‚Üí —Å–æ–∑–¥–∞–π –¥–∞—à–±–æ—Ä–¥ ‚Üí –Ω–∞—Å—Ç—Ä–æ–π –∞–ª–µ—Ä—Ç–∏–Ω–≥ ‚Üí —Å–¥–µ–ª–∞–π —Å–∫—Ä–∏–Ω—à–æ—Ç—ã

---


---
```
